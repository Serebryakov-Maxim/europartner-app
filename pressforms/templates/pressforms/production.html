{% extends 'pressforms/layout.html' %}
{% load static %}

{% block title %}
Прессформы в производстве
{% endblock %}

{% block link %}
  <link rel="stylesheet" href="{% static 'pressforms/css/production.css' %}">
{% endblock %}

{% block content %}
<div class="page_name">
    <h3> План работ по прессформам</h3>
</div>

<!-- Модальное окно -->
<div class="modal fade" id="Modal" tabindex="-1" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="left: 10px;">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title" id="ModalLabel">Название прессформы</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <form method="POST" action="{% url 'pressforms:operation' %}">
            {% csrf_token %}
            <h5 id="operation">Название операции</h5>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="oper" id="Radios1" value="0" checked style="background: #c3c3bf; ">
              <label class="form-check-label" for="Radios1">
                Пусто
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="oper" id="Radios2" value="1" style="background: #a1f003;">
              <label class="form-check-label" for="Radios2">
                Выполнено
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="oper" id="Radios3" value="2" style="background: #0073ff;">
              <label class="form-check-label" for="Radios3">
                Не требует выполнения
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="oper" id="Radios4" value="3" style="background: #f3bc07;">
              <label class="form-check-label" for="Radios4">
                В работе
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="oper" id="Radios5" value="4" style="background: #aa1614c9;">
              <label class="form-check-label" for="Radios5">
                Не выполнено
              </label>
            </div>

            <div>
              <label for="week">
                Неделя:
              </label>
              <input type="number" step="1" min="0" max="55" value="0" id="week" name="week">
            </div>
            
            <div class="row">
              <div class="col-4">
                <label for="datepicker">Дата завершения:</label>
              </div>
              <div class="col-2">
                <input type="text" id="date_finish" name="date_finish" class="form-control" style="width: 120px;">
              </div>
            </div>

            <div style="visibility: hidden;">
              <input id="pressform_id" type="number" name="pressform_id" value="0">
              <input id="work_id" type="number" name="work_id" value="0">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
              <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="my_table">
  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th scope="col" rowspan="2" class="col_property_pressform">Шильда</th>
        <th scope="col" rowspan="2" class="col_property_pressform">№</th>
        <th scope="col" rowspan="2" class="col_name_pressform">Наименование</th>
        <th scope="col" rowspan="2" class="col_property_pressform">Сборка</th>
        {% for current_type in typeWorks %}
          {% for el in count_type %}
            {% if current_type.id == el.type %}
              {% if el.dcount == 1 %}
                <th scope="col" rowspan="2" class="col_work_pressform">{{current_type.name}}</th>
              {% else %}
                <th scope="col" id="col_work_pressform_group" colspan="{{el.dcount}}">{{current_type.name}}</th>
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endfor %}
      </tr>
      <tr>
          {% for current_type in typeWorks %}
            {% for el in count_type %}
              {% if current_type.id == el.type and el.dcount != 1 %}
                  {% for el in works %}
                    {% if current_type.id == el.type.id %}
                      <th scope="col" class="col_work_pressform">{{el.name}}</th>
                    {% endif %}
                  {% endfor %}
              {% endif %}
            {% endfor %}
          {% endfor %}
      </tr>
    </thead>
    <tbody>
        {% for progress in list_progress %}
          <tr>
            {% if progress.pf.shield %}
              <td class="col_property_pressform">V</td>
            {% else %}
              <td></td>
            {% endif %}
            <td class="col_property_pressform">{{ forloop.counter }}</td>
            {% if progress.pf.type == 1 %}
              {% if progress.pf.status == 2 %}
                <td id="type_pf_our_ready">{{progress.pf.name}}</td>
              {% else %}
                <td id="type_pf_our">{{progress.pf.name}}</td>
              {% endif %}
            {% elif progress.pf.type == 2 %}
              <td id="type_pf_partner">{{progress.pf.name}}</td>
            {% elif progress.pf.type == 3 %}
              <td id="type_pf_import">{{progress.pf.name}}</td>
            {% else %}
              <td>{{progress.pf.name}}</td>
            {% endif %}
            <td class="col_property_pressform">{{progress.pf.assembly}}</td>
            {% for el in progress.list_works %}
              <td class="col_work_progress">
                  <a href="" class="cell_progress" data-bs-toggle="modal" data-date_finish="{{el.date_finish}}" data-work-name="{{el.work.name}}" data-pressform-name="{{progress.pf.name}}" data-work-id="{{el.work.id}}" data-week="{{el.week}}" data-progress="{{el.progress}}" data-pressform-id="{{progress.pf.id}}" data-bs-target="#Modal">
                    {% if el.progress == 1 %}
                      <div class="circle circle_color_green">
                    {% elif el.progress == 2 %}
                      <div class="circle circle_color_blue">
                    {% elif el.progress == 3 %}
                      <div class="circle circle_color_yellow">
                    {% elif el.progress == 4 %}
                        <div class="circle circle_color_red">
                    {% else %}
                      <div class="circle circle_color_grey">
                    {% endif %}
                      {% if el.week_name != '0' %}
                        {{el.week_name|linebreaksbr}}
                      {% endif %}
                    </div>
                  </a>
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
    </tbody>
  </table>
</div>
<div class="footer">
  <table class="footer-table">
    <tr>
      <td><div class="square footer-td" id="type_pf_our"></div></td>
      <td>Европартнер (в работе)</td>
      <td><div class="square footer-td" id="type_pf_our_ready"></div></td>
      <td>Европартнер (выполнено)</td>
      <td><div class="square footer-td" id="type_pf_partner"></div></td>
      <td>Клиент</td>
      <td><div class="square footer-td" id="type_pf_import"></div></td>
      <td>Импорт</td>
      <td style="width: 50px;"></td>
      <td><div class="circle circle_color_blue footer-td"></div></td>
      <td>Не требует выполнения</td>
      <td><div class="circle circle_color_yellow footer-td"></div></td>
      <td>В работе</td>
      <td><div class="circle circle_color_red footer-td"></div></td>
      <td>Не выполнено</td>
      <td><div class="circle circle_color_green footer-td"></div></td>
      <td>Выполнено</td>
    </tr>
  </table>  
</div>
<script>
  var date_modified = getDateModified();
  var Modal = document.getElementById('Modal');

  Modal.addEventListener('show.bs.modal', function (event) {
    // Button that triggered the modal
    var button = event.relatedTarget
    // Extract info from data-bs-* attributes
    var work_id = button.getAttribute('data-work-id')
    var pressform_id = button.getAttribute('data-pressform-id')
    var work_name = button.getAttribute('data-work-name')
    var pressform_name = button.getAttribute('data-pressform-name')
    var week = button.getAttribute('data-week')
    var date_finish = button.getAttribute('data-date_finish')
    var progress = button.getAttribute('data-progress')
    
    Modal.querySelector('.modal-title').textContent = '' + pressform_name
    document.getElementById('operation').textContent = work_name
    document.getElementById('pressform_id').value = pressform_id
    document.getElementById('work_id').value = work_id
    document.getElementById('week').value = week
    document.getElementById('date_finish').value = date_finish
    

    if (progress == 0)
      document.getElementById('Radios1').checked = true
    else if (progress == 1)
      document.getElementById('Radios2').checked = true
    else if (progress == 2)
      document.getElementById('Radios3').checked = true
    else if (progress == 3)
      document.getElementById('Radios4').checked = true
    else if (progress == 4)
      document.getElementById('Radios5').checked = true
    else
      document.getElementById('Radios1').checked = true

    })

    setInterval(function(){
      last_modified = getDateModified();
      if (date_modified < last_modified) {
        window.location.reload(1);
        date_modified = last_modified;
      }
    }, 5000);

  function getDateModified(){
    theUrl = window.location.protocol + "//" + window.location.host + "/pressforms/api/last_modified/";
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", theUrl, false ); // false for synchronous request
    xmlHttp.send( null );
    responseText = xmlHttp.responseText;
    return Date.parse(JSON.parse(responseText)["date_modified"]);
  };

  $(function() {
     $('#date_finish').datepicker({
      autoclose: true,
      language: "ru",
      daysOfWeekHighlighted: "0,6",
     });
   });


</script>
{% endblock %}